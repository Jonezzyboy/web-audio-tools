<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notification Sound Designer</title>
  <style>
    :root {
      --primary: #007bff;
      --bg: #f4f7f6;
      --card: #ffffff;
      --text: #333;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }

    .container {
      background: var(--card);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      width: 100%;
      max-width: 400px;
    }

    h1 {
      margin-top: 0;
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .control-group {
      margin-bottom: 1.25rem;
    }

    .label-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .value-display {
      color: var(--primary);
      font-family: monospace;
    }

    input[type=range] {
      width: 100%;
      cursor: pointer;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 2rem;
    }

    button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }

    button:active {
      transform: scale(0.96);
    }

    #playBtn {
      background: #e2e6ea;
      color: #333;
    }

    #playBtn:hover {
      background: #dbe0e5;
    }

    #downloadBtn {
      background: var(--primary);
      color: white;
    }

    #downloadBtn:hover {
      opacity: 0.9;
    }

    /* Visualizer (Simple) */
    #visualizer {
      height: 4px;
      background: #eee;
      margin-top: 20px;
      border-radius: 2px;
      overflow: hidden;
    }

    #bar {
      height: 100%;
      width: 0%;
      background: var(--primary);
      transition: width 0.1s;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Notification Designer</h1>

  <div class="control-group">
    <div class="label-row">
      <label>Base Pitch (Tone)</label>
      <span id="pitchVal" class="value-display">440 Hz</span>
    </div>
    <input type="range" id="pitch" min="200" max="800" value="440">
  </div>

  <div class="control-group">
    <div class="label-row">
      <label>Harmony (2nd Tap)</label>
      <span id="intervalVal" class="value-display">1.2x</span>
    </div>
    <input type="range" id="interval" min="1.0" max="2.0" step="0.05" value="1.19">
    <small style="color:#888; font-size: 0.75rem;">1.2 = Minor 3rd, 1.5 = Perfect 5th</small>
  </div>

  <div class="control-group">
    <div class="label-row">
      <label>Speed (Gap)</label>
      <span id="speedVal" class="value-display">120 ms</span>
    </div>
    <input type="range" id="speed" min="50" max="400" step="10" value="120">
  </div>

  <div class="control-group">
    <div class="label-row">
      <label>Decay (Tightness)</label>
      <span id="decayVal" class="value-display">Short</span>
    </div>
    <input type="range" id="decay" min="1" max="3" step="1" value="2">
  </div>

  <div class="btn-row">
    <button id="playBtn">▶ Play Preview</button>
    <button id="downloadBtn">⬇ Download WAV</button>
  </div>

  <div id="visualizer">
    <div id="bar"></div>
  </div>
</div>

<script>
  // --- UI References ---
  const els = {
    pitch:       document.getElementById('pitch'),
    interval:    document.getElementById('interval'),
    speed:       document.getElementById('speed'),
    decay:       document.getElementById('decay'),
    valPitch:    document.getElementById('pitchVal'),
    valInterval: document.getElementById('intervalVal'),
    valSpeed:    document.getElementById('speedVal'),
    valDecay:    document.getElementById('decayVal'),
    bar:         document.getElementById('bar')
  };

  // --- Update Displays ---
  const updateLabels = () =>
  {
    els.valPitch.innerText = `${els.pitch.value} Hz`;
    els.valInterval.innerText = `${els.interval.value}x`;
    els.valSpeed.innerText = `${els.speed.value} ms`;

    const decayMap = ['Very Tight', 'Normal', 'Ringing'];
    els.valDecay.innerText = decayMap[parseInt(els.decay.value) - 1];
  };

  [els.pitch, els.interval, els.speed, els.decay].forEach(el => el.addEventListener('input', updateLabels));
  updateLabels(); // Init

  // --- THE CORE AUDIO ENGINE ---
  // This logic is shared by both Play and Download to ensure consistency
  function scheduleSound(ctx, destination, startTime)
  {
    const basePitch = parseInt(els.pitch.value);
    const interval = parseFloat(els.interval.value);
    const gap = parseInt(els.speed.value) / 1000; // ms to seconds
    const decaySetting = parseInt(els.decay.value);

    // Decay Multipliers: 1=Fast, 2=Medium, 3=Slow
    const decay1 = 0.1 * (decaySetting * 0.7);
    const decay2 = 0.25 * (decaySetting * 0.7);

    // Helper to create one "Pluck"
    const triggerOsc = (time, freq, dur) =>
    {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, time);

      // Envelope
      gain.gain.setValueAtTime(0, time);
      gain.gain.linearRampToValueAtTime(0.1, time + 0.01); // Fast attack
      gain.gain.exponentialRampToValueAtTime(0.001, time + dur); // Decay

      osc.connect(gain);
      gain.connect(destination);

      osc.start(time);
      osc.stop(time + dur + 0.1);
    };

    // Tap 1
    triggerOsc(startTime, basePitch, decay1);

    // Tap 2 (Higher pitch, slightly longer)
    triggerOsc(startTime + gap, basePitch * interval, decay2);

    return startTime + gap + decay2; // Return end time
  }

  // --- PLAY PREVIEW ---
  document.getElementById('playBtn').addEventListener('click', () =>
  {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();
    const now = ctx.currentTime;

    // Visualizer flash
    els.bar.style.width = '100%';
    setTimeout(() => els.bar.style.width = '0%', 150);

    scheduleSound(ctx, ctx.destination, now);
  });

  // --- DOWNLOAD WAV (Offline Rendering) ---
  document.getElementById('downloadBtn').addEventListener('click', async () =>
  {
    const btn = document.getElementById('downloadBtn');
    const originalText = btn.innerText;
    btn.innerText = 'Rendering...';

    // 1. Setup Offline Context (High res: 44.1kHz)
    const sampleRate = 44100;
    const duration = 1.5; // Seconds
    const ctx = new OfflineAudioContext(1, sampleRate * duration, sampleRate);

    // 2. Schedule sound (with small padding at start to prevent clipping)
    scheduleSound(ctx, ctx.destination, 0.1);

    // 3. Render
    const renderedBuffer = await ctx.startRendering();

    // 4. Convert to WAV and Download
    const wavBytes = bufferToWave(renderedBuffer, 0.0, duration);
    const blob = new Blob([wavBytes], {type: 'audio/wav'});
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `notification_${els.pitch.value}hz.wav`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);

    btn.innerText = originalText;
  });

  // --- WAV HEADER HELPER (Standard Boilerplate) ---
  function bufferToWave(abuffer, offset, len)
  {
    let numOfChan = abuffer.numberOfChannels,
      length = len * abuffer.sampleRate * numOfChan * 2 + 44,
      buffer = new ArrayBuffer(length),
      view = new DataView(buffer),
      channels = [], i, sample,
      pos = 0;

    setUint32(0x46464952);
    setUint32(length - 8);
    setUint32(0x45564157); // RIFF, length, WAVE
    setUint32(0x20746d66);
    setUint32(16);
    setUint16(1);
    setUint16(numOfChan); // fmt, pcm
    setUint32(abuffer.sampleRate);
    setUint32(abuffer.sampleRate * 2 * numOfChan);
    setUint16(numOfChan * 2);
    setUint16(16);
    setUint32(0x61746164);
    setUint32(length - pos - 4); // data

    for(i = 0; i < abuffer.numberOfChannels; i++)
    {
      channels.push(abuffer.getChannelData(i));
    }

    while(pos < length)
    {
      for(i = 0; i < numOfChan; i++)
      {
        sample = Math.max(-1, Math.min(1, channels[i][offset]));
        sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0;
        view.setInt16(pos, sample, true);
        pos += 2;
      }
      offset++;
    }
    return buffer;

    function setUint16(data)
    {
      view.setUint16(pos, data, true);
      pos += 2;
    }

    function setUint32(data)
    {
      view.setUint32(pos, data, true);
      pos += 4;
    }
  }
</script>
</body>
</html>